name: Assembly HTTP Server CI

on:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y nasm curl wrk

    - name: Build HTTP server
      run: |
        make test

    - name: Start HTTP server
      run: |
        ./examples/test/server 1337 &
        echo $! > server.pid
        sleep 2  # Wait for server to be ready

    - name: Run example tests
      run: |
        chmod +x scripts/test.sh
        ./scripts/test.sh

    - name: Run wrk benchmark
      run: |
        echo "Running wrk on /index..."
        wrk -t1 -c1 -d30s --latency http://localhost:1337/index

        echo "Running wrk on /not-found..."
        wrk -t1 -c1 -d30s --latency http://localhost:1337/not-found

    - name: Kill server
      run: |
        kill $(cat server.pid)

    - name: Build echo server
      run: |
        make echo

    - name: Start echo server
      run: |
        ./examples/echo/echo &
        echo $! > server.pid
        sleep 2  # Wait for server to be ready

    - name: Run echo tests
      run: |
        chmod +x scripts/test_echo.sh
        ./scripts/test_echo.sh

    - name: Run malloc tests
      run: |
        cd lib/malloc/tests
        make

    - name: Kill server
      run: |
        kill $(cat server.pid)
