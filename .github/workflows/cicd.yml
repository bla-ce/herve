name: Assembly HTTP Server CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y nasm curl wrk

    - name: Build HTTP server
      run: |
        make PROGRAM_NAME=examples/test/server

    - name: Start HTTP server
      run: |
        ./examples/test/server 1337 &
        echo $! > server.pid
        sleep 2  # Wait for server to be ready

    - name: Run example tests
      run: |
        chmod +x test.sh
        ./test.sh

    - name: Run wrk benchmark
      run: |
        echo "Running wrk..."
        wrk -t1 -c1 -d30s --latency http://localhost:1337/index > wrk_output.txt

        echo "wrk results:"
        cat wrk_output.txt

        # Extract avg latency
        avg_latency=$(grep 'Latency' wrk_output.txt | awk '{print $2}')

        echo "Average latency: $avg_latency"

        # Convert to milliseconds
        if [[ "$avg_latency" == *ms ]]; then
          latency_ms=$(echo $avg_latency | sed 's/ms//')
        elif [[ "$avg_latency" == *s ]]; then
          latency_ms=$(echo "$avg_latency" | sed 's/s//' | awk '{print $1 * 1000}')
        else
          echo "Unrecognized latency format: $avg_latency"
          exit 1
        fi

        threshold=80
        latency_int=$(printf "%.0f" "$latency_ms")

        if [ "$latency_int" -gt "$threshold" ]; then
          echo "[ERROR] Average latency ${latency_int}ms exceeds threshold of ${threshold}ms"
          exit 1
        else
          echo "[SUCCESS] Average latency ${latency_int}ms is within acceptable limits"
        fi

    - name: Kill server
      run: |
        kill $(cat server.pid)
